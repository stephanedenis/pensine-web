<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test Manual - GitHub Token Validation</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #33ff33; }
    button { padding: 10px 20px; margin: 10px 0; font-size: 16px; cursor: pointer; }
    pre { background: #0a0a0a; padding: 10px; border: 1px solid #33ff33; }
    .error { color: #ff3333; }
    .success { color: #33ff33; }
    .info { color: #3333ff; }
  </style>
</head>
<body>
  <h1>üîê GitHub Token Validation Test</h1>

  <div>
    <label>GitHub Owner: <input id="owner" value="stephanedenis" /></label><br>
    <label>GitHub Repo: <input id="repo" value="pensine-data" /></label><br>
    <label>GitHub Token: <input id="token" type="password" value="REMOVED_TOKEN" /></label><br>
    <button onclick="testValidation()">üß™ Test Validation</button>
  </div>

  <h2>üìã Results:</h2>
  <pre id="output">Waiting for test...</pre>

  <script type="module">

    async function testValidation() {
      const output = document.getElementById('output');
      output.innerHTML = '‚è≥ Running validation test...\n\n';

      try {
        const owner = document.getElementById('owner').value;
        const repo = document.getElementById('repo').value;
        const token = document.getElementById('token').value;

        output.innerHTML += `üìã Configuration:\n`;
        output.innerHTML += `   Owner: ${owner}\n`;
        output.innerHTML += `   Repo: ${repo}\n`;
        output.innerHTML += `   Token: ${token.substring(0, 10)}...\n\n`;

        // Step 1: Import StorageAdapterBase
        output.innerHTML += 'üîç Step 1: Import StorageAdapterBase...\n';
        const { default: StorageAdapterBase } = await import('./src/lib/adapters/storage-adapter-base.js');
        output.innerHTML += `   ‚úÖ StorageAdapterBase imported: ${typeof StorageAdapterBase}\n\n`;

        // Step 2: Import GitHubStorageAdapter
        output.innerHTML += 'üîç Step 2: Import GitHubStorageAdapter...\n';
        const { default: GitHubStorageAdapter } = await import('./src/lib/adapters/github-storage-adapter.js');
        output.innerHTML += `   ‚úÖ GitHubStorageAdapter imported: ${typeof GitHubStorageAdapter}\n`;
        output.innerHTML += `   ‚úÖ Extends StorageAdapterBase: ${GitHubStorageAdapter.prototype instanceof StorageAdapterBase}\n\n`;

        // Step 3: Create adapter instance
        output.innerHTML += 'üîç Step 3: Create adapter instance...\n';
        const adapter = new GitHubStorageAdapter();
        output.innerHTML += `   ‚úÖ Adapter created: ${adapter.constructor.name}\n\n`;

        // Step 4: Configure adapter
        output.innerHTML += 'üîç Step 4: Configure adapter...\n';
        await adapter.configure({
          owner: owner,
          repo: repo,
          token: token
        });
        output.innerHTML += `   ‚úÖ Adapter configured\n\n`;

        // Step 5: Test GitHub API
        output.innerHTML += 'üîç Step 5: Test GitHub API /user...\n';
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        output.innerHTML += `   ‚ÑπÔ∏è Response status: ${response.status} ${response.statusText}\n`;

        if (!response.ok) {
          const errorText = await response.text();
          output.innerHTML += `   ‚ùå API Error: ${errorText}\n\n`;
          throw new Error(`GitHub API returned ${response.status}`);
        }

        const userData = await response.json();
        output.innerHTML += `   ‚úÖ User authenticated: ${userData.login}\n`;
        output.innerHTML += `   ‚ÑπÔ∏è Name: ${userData.name || 'N/A'}\n`;
        output.innerHTML += `   ‚ÑπÔ∏è Public repos: ${userData.public_repos}\n\n`;

        // Step 6: Test repository access
        output.innerHTML += 'üîç Step 6: Test repository access...\n';
        const repoResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        output.innerHTML += `   ‚ÑπÔ∏è Response status: ${repoResponse.status} ${repoResponse.statusText}\n`;

        if (!repoResponse.ok) {
          const errorText = await repoResponse.text();
          output.innerHTML += `   ‚ö†Ô∏è Repo access issue: ${errorText}\n\n`;
        } else {
          const repoData = await repoResponse.json();
          output.innerHTML += `   ‚úÖ Repository accessible: ${repoData.full_name}\n`;
          output.innerHTML += `   ‚ÑπÔ∏è Default branch: ${repoData.default_branch}\n`;
          output.innerHTML += `   ‚ÑπÔ∏è Private: ${repoData.private}\n\n`;
        }

        output.innerHTML += '\n‚úÖ ========== VALIDATION SUCCESS ==========\n';
        output.innerHTML += 'All imports work correctly\n';
        output.innerHTML += 'GitHub API authentication successful\n';
        output.innerHTML += 'No "StorageAdapterBase is not defined" error\n';
        output.innerHTML += 'No "constructor" error\n';
        output.innerHTML += '==========================================\n';

      } catch (error) {
        output.innerHTML += `\n‚ùå ========== ERROR ==========\n`;
        output.innerHTML += `Error: ${error.message}\n`;
        output.innerHTML += `Stack: ${error.stack}\n`;
        output.innerHTML += `==============================\n`;
      }
    }

    // Make function globally available
    window.testValidation = testValidation;

  </script>
</body>
</html>
