<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test Minimal - Token Validation</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 { color: #333; }
        .box {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px 10px 0;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #007acc; color: white; }
        .btn-primary:hover { background: #005a9e; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        #result {
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.6;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; }
        .step {
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-left: 3px solid #007acc;
        }
        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            color: #e83e8c;
        }
    </style>
</head>
<body>
    <h1>üî¨ Test Minimal - Validation Token</h1>

    <div class="box">
        <h3>Configuration</h3>
        <label>Token GitHub (ghp_...):</label>
        <input type="password" id="token" placeholder="ghp_...">
        <button class="btn-secondary" id="toggleBtn">üëÅÔ∏è Afficher/Masquer</button>
    </div>

    <div class="box">
        <h3>Actions</h3>
        <button class="btn-primary" id="testBtn">üîç Valider le Token</button>
        <button class="btn-secondary" id="diagBtn">üî¨ Diagnostiquer les Modules</button>
    </div>

    <div class="box">
        <h3>R√©sultat</h3>
        <div id="result">Cliquez sur "Valider le Token" pour tester...</div>
    </div>

    <div class="box">
        <h3>üí° En cas de probl√®me</h3>
        <ol>
            <li>Ouvrir DevTools (F12) ‚Üí Console</li>
            <li>V√©rifier les erreurs JavaScript</li>
            <li>Cliquer sur "Diagnostiquer les Modules"</li>
            <li>Si probl√®me persiste: <a href="/tests/manual/diagnostic-modules.html" target="_blank">Diagnostic complet</a></li>
        </ol>
    </div>

    <script type="module">
        const tokenInput = document.getElementById('token');
        const resultDiv = document.getElementById('result');
        const testBtn = document.getElementById('testBtn');
        const toggleBtn = document.getElementById('toggleBtn');
        const diagBtn = document.getElementById('diagBtn');

        // Toggle visibility
        toggleBtn.addEventListener('click', () => {
            tokenInput.type = tokenInput.type === 'password' ? 'text' : 'password';
            toggleBtn.textContent = tokenInput.type === 'password' ? 'üëÅÔ∏è Afficher' : 'üôà Masquer';
        });

        // Diagnostics
        diagBtn.addEventListener('click', () => {
            window.open('/tests/manual/diagnostic-modules.html', '_blank');
        });

        // Main test
        testBtn.addEventListener('click', async () => {
            const token = tokenInput.value.trim().replace(/[\r\n\t]/g, '');

            resultDiv.innerHTML = '';

            function log(message, type = 'info') {
                const classes = {
                    'info': 'info',
                    'success': 'success',
                    'error': 'error',
                    'step': 'step'
                };
                const div = document.createElement('div');
                div.className = classes[type] || 'info';
                div.textContent = message;
                resultDiv.appendChild(div);
            }

            if (!token) {
                log('‚ùå Veuillez entrer un token', 'error');
                return;
            }

            log('üîç Validation du token en cours...', 'step');
            log(`Token length: ${token.length}`, 'info');
            log(`Token start: ${token.substring(0, 10)}...`, 'info');

            testBtn.disabled = true;

            try {
                // Step 1: Import module
                log('\nüì¶ √âtape 1: Import du module GitHubStorageAdapter...', 'step');
                const { default: GitHubStorageAdapter } = await import('/src/lib/adapters/github-storage-adapter.js?v=' + Date.now());
                log('‚úÖ Module import√© avec succ√®s', 'success');

                // Step 2: Create instance
                log('\nüèóÔ∏è  √âtape 2: Cr√©ation de l\'instance...', 'step');
                const adapter = new GitHubStorageAdapter();
                adapter.token = token;
                adapter.mode = 'pat';
                log(`‚úÖ Instance cr√©√©e (mode: ${adapter.mode})`, 'success');

                // Step 3: Call API
                log('\nüåê √âtape 3: Appel API GitHub /user...', 'step');
                log('Request: GET https://api.github.com/user', 'info');
                log('Header: Authorization: token ' + token.substring(0, 10) + '...', 'info');

                const userInfo = await adapter.request('/user');

                log('\n‚úÖ TOKEN VALIDE !', 'success');
                log(`\nUsername: ${userInfo.login}`, 'info');
                log(`Nom: ${userInfo.name || 'N/A'}`, 'info');
                log(`Email: ${userInfo.email || 'N/A'}`, 'info');
                log(`Type: ${userInfo.type}`, 'info');
                log(`ID: ${userInfo.id}`, 'info');

                log('\nüìù Note importante:', 'step');
                log('Le owner (username) est r√©cup√©r√© DEPUIS la r√©ponse API.', 'info');
                log('Il n\'est PAS envoy√© dans la requ√™te HTTP.', 'info');
                log('Ceci est le comportement NORMAL de l\'API GitHub.', 'info');

            } catch (error) {
                log('\n‚ùå ERREUR DE VALIDATION', 'error');
                log(`\nMessage: ${error.message}`, 'error');

                if (error.message.includes('does not provide an export')) {
                    log('\nüîß Probl√®me de cache de module d√©tect√©', 'step');
                    log('Solutions:', 'info');
                    log('1. Ctrl+Shift+R pour Hard Reload', 'info');
                    log('2. Ouvrir /tests/manual/clear-cache.html', 'info');
                    log('3. DevTools ‚Üí Application ‚Üí Clear site data', 'info');
                } else if (error.message.includes('401') || error.message.includes('Bad credentials')) {
                    log('\nüîë Token invalide ou expir√©', 'step');
                    log('V√©rifiez que vous avez copi√© le token complet depuis GitHub', 'info');
                } else if (error.message.includes('403')) {
                    log('\nüîí Permissions insuffisantes', 'step');
                    log('Le token doit avoir le scope "repo"', 'info');
                } else if (error.message.includes('ISO-8859-1')) {
                    log('\nüìù Caract√®res invalides dans le token', 'step');
                    log('Le token contient des espaces ou caract√®res invisibles', 'info');
                }

                log(`\nüìö Stack trace:`, 'step');
                log(error.stack, 'error');

                console.error('Full error:', error);
            } finally {
                testBtn.disabled = false;
            }
        });

        // Load token from URL if present
        const params = new URLSearchParams(window.location.search);
        if (params.get('token')) {
            tokenInput.value = params.get('token');
            if (params.get('auto') === 'true') {
                setTimeout(() => testBtn.click(), 500);
            }
        }
    </script>
</body>
</html>
