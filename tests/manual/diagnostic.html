<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Diagnostic Cache - Pensine</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .info {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üîß Diagnostic Cache - Pensine</h1>

    <div class="card">
        <h2>√âtat actuel</h2>
        <div id="status"></div>
    </div>

    <div class="card">
        <h2>Actions</h2>
        <button onclick="checkCache()">üîç V√©rifier Cache</button>
        <button onclick="clearAllCaches()" class="danger">üßπ Nettoyer Tous les Caches</button>
        <button onclick="testImports()">üì¶ Tester Imports</button>
        <button onclick="window.location.href='/'">üè† Retour App</button>
    </div>

    <div class="card">
        <h2>Informations</h2>
        <div id="info"></div>
    </div>

    <div class="card">
        <h2>Derni√®re erreur enregistr√©e</h2>
        <div id="error"></div>
    </div>

    <script src="/src/lib/utils/cache-buster.js"></script>
    <script>
        const cacheBuster = new CacheBuster();

        async function checkCache() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p>‚è≥ V√©rification en cours...</p>';

            const checks = [];

            // Version check
            const shouldClear = cacheBuster.shouldClearCache();
            checks.push({
                name: 'Version de l\'app',
                status: shouldClear ? 'warning' : 'ok',
                message: shouldClear
                    ? `Version obsol√®te d√©tect√©e (actuelle: ${localStorage.getItem('pensine-app-version')}, attendue: ${cacheBuster.APP_VERSION})`
                    : `Version √† jour (${cacheBuster.APP_VERSION})`
            });

            // LocalStorage check
            const lsSize = JSON.stringify(localStorage).length;
            checks.push({
                name: 'LocalStorage',
                status: lsSize > 5000000 ? 'warning' : 'ok',
                message: `Taille: ${(lsSize / 1024).toFixed(2)} KB`
            });

            // Cache API check
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                checks.push({
                    name: 'Cache API',
                    status: cacheNames.length > 0 ? 'warning' : 'ok',
                    message: `${cacheNames.length} cache(s) trouv√©(s): ${cacheNames.join(', ')}`
                });
            }

            // Service Workers check
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                checks.push({
                    name: 'Service Workers',
                    status: registrations.length > 0 ? 'warning' : 'ok',
                    message: `${registrations.length} worker(s) enregistr√©(s)`
                });
            }

            // Render results
            let html = '';
            checks.forEach(check => {
                html += `
                    <div class="status ${check.status}">
                        <strong>${check.name}:</strong> ${check.message}
                    </div>
                `;
            });

            statusDiv.innerHTML = html;
        }

        async function clearAllCaches() {
            if (!confirm('‚ö†Ô∏è Cette action va supprimer tous les caches (sauf vos donn√©es de configuration). Continuer ?')) {
                return;
            }

            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p class="status warning">‚è≥ Nettoyage en cours...</p>';

            try {
                const success = await cacheBuster.clearAllCaches();

                if (success) {
                    statusDiv.innerHTML = `
                        <div class="status ok">
                            <p>‚úÖ Tous les caches ont √©t√© nettoy√©s avec succ√®s !</p>
                            <p>L'application va maintenant recharger...</p>
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            <p>‚ùå Erreur lors du nettoyage des caches.</p>
                            <p>Essayez de vider le cache manuellement via les outils d√©veloppeur (F12).</p>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <p>‚ùå Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testImports() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<p>‚è≥ Test des imports en cours...</p>';

            const results = [];

            // Test storage-adapter-base
            try {
                const { default: StorageAdapterBase } = await import(`/src/lib/adapters/storage-adapter-base.js?v=${Date.now()}`);
                results.push({
                    module: 'StorageAdapterBase',
                    status: 'ok',
                    message: '‚úÖ Import r√©ussi'
                });
            } catch (error) {
                results.push({
                    module: 'StorageAdapterBase',
                    status: 'error',
                    message: `‚ùå ${error.message}`
                });
            }

            // Test github-storage-adapter
            try {
                const { default: GitHubStorageAdapter } = await import(`/src/lib/adapters/github-storage-adapter.js?v=${Date.now()}`);
                results.push({
                    module: 'GitHubStorageAdapter',
                    status: 'ok',
                    message: '‚úÖ Import r√©ussi'
                });
            } catch (error) {
                results.push({
                    module: 'GitHubStorageAdapter',
                    status: 'error',
                    message: `‚ùå ${error.message}`
                });
            }

            // Render results
            let html = '<h3>R√©sultats des tests d\'import:</h3>';
            results.forEach(result => {
                html += `
                    <div class="status ${result.status}">
                        <strong>${result.module}:</strong> ${result.message}
                    </div>
                `;
            });

            statusDiv.innerHTML = html;
        }

        // Show info
        function showInfo() {
            const infoDiv = document.getElementById('info');
            infoDiv.innerHTML = `
                <div class="info">
                    <p><strong>Version:</strong> ${cacheBuster.APP_VERSION}</p>
                    <p><strong>User Agent:</strong> ${navigator.userAgent}</p>
                    <p><strong>URL:</strong> ${window.location.href}</p>
                    <p><strong>Timestamp:</strong> ${new Date().toISOString()}</p>
                </div>
            `;
        }

        // Show last error
        function showLastError() {
            const errorDiv = document.getElementById('error');
            const lastError = localStorage.getItem('pensine-last-error');

            if (lastError) {
                try {
                    const error = JSON.parse(lastError);
                    errorDiv.innerHTML = `
                        <div class="status error">
                            <p><strong>Message:</strong> ${error.message}</p>
                            <p><strong>Timestamp:</strong> ${error.timestamp}</p>
                            <pre>${error.stack || 'N/A'}</pre>
                        </div>
                    `;
                } catch (e) {
                    errorDiv.innerHTML = '<p class="info">Erreur lors du parsing des logs</p>';
                }
            } else {
                errorDiv.innerHTML = '<p class="info">Aucune erreur enregistr√©e</p>';
            }
        }

        // Initialize
        checkCache();
        showInfo();
        showLastError();
    </script>
</body>
</html>
