<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pensine</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/calendar.css">
    <link rel="stylesheet" href="lib/components/linear-calendar/linear-calendar-v2.css">
    <link rel="stylesheet" href="styles/editor.css">
    <link rel="stylesheet" href="styles/wizard.css">
    <link rel="stylesheet" href="styles/settings.css">

    <!-- MarkdownIt + Extensions -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it-anchor@9.0.1/dist/markdownItAnchor.umd.min.js"></script>

    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/es/highlight.min.js"></script>

    <!-- Buffer polyfill (required for isomorphic-git) -->
    <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
    <script>
        // Make Buffer global for isomorphic-git
        if (typeof window.Buffer === 'undefined') {
            window.Buffer = buffer.Buffer;
        }
    </script>

    <!-- isomorphic-git + LightningFS for Local Git mode -->
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
    <script src="https://unpkg.com/isomorphic-git"></script>
</head>

<body>
    <div id="app">
        <!-- Header -->
        <header id="header">
            <div class="header-left">
                <h1>ğŸ§  Pensine <span class="version">v0.0.22</span></h1>
                <span id="sync-status" class="status-indicator">â—</span>
            </div>
            <div class="header-right">
                <button id="docs-btn" title="Documentation">ğŸ“š</button>
                <button id="calendar-btn" title="Calendrier">ğŸ“†</button>
                <button id="history-btn" title="Historique">ğŸ“œ</button>
                <button id="sync-btn" title="Sync avec GitHub">ğŸ”„</button>
                <button id="settings-btn" title="ParamÃ¨tres">âš™ï¸</button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside id="sidebar">
            <nav>
                <ul>
                    <li><a href="#" data-view="journal" class="active">ğŸ“… Journal</a></li>
                    <li><a href="#" data-view="pages">ğŸ“„ Pages</a></li>
                    <li><a href="#" data-view="search">ğŸ” Recherche</a></li>
                </ul>
            </nav>

            <div id="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button id="calendar-today" title="Aujourd'hui">â—</button>
                        <button id="calendar-config-btn" title="Configuration calendrier">âš™ï¸</button>
                    </div>
                </div>
                <div id="linear-calendar"></div>
            </div>

            <div id="recent-pages" class="hidden">
                <h3>Pages RÃ©centes</h3>
                <ul id="recent-list"></ul>
            </div>
        </aside>

        <!-- Sidebar Resize Handle -->
        <div id="sidebar-resize-handle" class="resize-handle resize-handle-vertical"></div>

        <!-- Main Content -->
        <main id="content">
            <!-- Remote Change Notification -->
            <div id="remote-change-banner" class="notification-banner hidden">
                <span>âš ï¸ Le fichier a Ã©tÃ© modifiÃ© sur le serveur</span>
                <div class="banner-actions">
                    <button id="reload-file-btn" class="btn-reload">ğŸ”„ Recharger</button>
                    <button id="ignore-changes-btn" class="btn-ignore">âŒ Ignorer</button>
                </div>
            </div>

            <div id="loading" class="loading">Chargement...</div>
            <div id="error" class="error hidden"></div>

            <!-- Unified Editor (for journals, pages, config, etc.) -->
            <div id="editor-container" class="hidden">
                <!-- Editor Header with View Mode Controls -->
                <div class="editor-header">
                    <div class="editor-title">
                        <span id="editor-file-name"></span>
                        <span id="editor-file-type" class="file-type-badge"></span>
                    </div>
                    <div class="editor-controls">
                        <div class="view-mode-switcher">
                            <button id="view-mode-code" class="view-mode-btn" data-mode="code" title="Vue Code">
                                &lt;/&gt;
                            </button>
                            <button id="view-mode-rich" class="view-mode-btn active" data-mode="rich"
                                title="Vue Enrichie">
                                ğŸ‘ï¸
                            </button>
                            <button id="view-mode-split" class="view-mode-btn" data-mode="split" title="Side-by-side">
                                â¬Œ
                            </button>
                        </div>
                        <button id="editor-save-btn" class="btn-primary" title="Sauvegarder (Ctrl+S)">
                            ğŸ’¾ Sauvegarder
                        </button>
                        <button id="editor-close-btn" class="btn-secondary" title="Fermer">
                            âœ•
                        </button>
                    </div>
                </div>

                <!-- Editor Content Area -->
                <div class="editor-content">
                    <!-- Code View (always present, shown/hidden) -->
                    <div id="editor-code-view" class="editor-pane">
                        <textarea id="editor-code-textarea" class="code-editor" aria-label="Ã‰diteur de code"></textarea>
                    </div>

                    <!-- Rich View (rendered content) -->
                    <div id="editor-rich-view" class="editor-pane">
                        <div id="editor-rich-content" class="rich-content"></div>
                    </div>
                </div>
            </div>

            <!-- Journal View (legacy, will integrate with editor) -->
            <div id="journal-view" class="view active">
                <div class="journal-header">
                    <button id="prev-day">â—€</button>
                    <h2 id="current-date">Aujourd'hui</h2>
                    <button id="next-day">â–¶</button>
                    <button id="today-btn">Aujourd'hui</button>
                </div>
                <div id="journal-content" class="editor"></div>
            </div>

            <!-- Pages View -->
            <div id="pages-view" class="view">
                <div class="pages-header">
                    <input type="text" id="page-search" placeholder="Rechercher une page...">
                    <button id="new-page-btn">â• Nouvelle Page</button>
                </div>
                <ul id="pages-list"></ul>
            </div>

            <!-- Graph View -->
            <div id="graph-view" class="view">
                <canvas id="graph-canvas"></canvas>
            </div>

            <!-- Search View -->
            <div id="search-view" class="view">
                <input type="text" id="search-input" placeholder="Rechercher...">
                <div id="search-results"></div>
            </div>
        </main>
    </div>

    <!-- Right Sidebar - History (outside grid) -->
    <aside id="history-sidebar">
        <h3>ğŸ“œ Historique <button id="close-history" title="Fermer">âœ–</button></h3>
        <ul id="history-list">
            <li class="history-empty">Aucun historique</li>
        </ul>
    </aside>

    <!-- Scripts -->
    <script src="config/config.js"></script>

    <!-- Cache Buster - Load FIRST to handle cache issues -->
    <script src="src/lib/utils/cache-buster.js"></script>
    <script>
        // Check version on startup
        if (window.cacheBuster) {
            window.cacheBuster.checkOnStartup();
        }

        // Global error handler for critical errors
        window.addEventListener('error', (event) => {
            if (window.cacheBuster && window.cacheBuster.isCriticalError(event.error)) {
                event.preventDefault();
                window.cacheBuster.handleCriticalError(event.error);
            }
        });

        // Promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            if (window.cacheBuster && window.cacheBuster.isCriticalError(event.reason)) {
                event.preventDefault();
                window.cacheBuster.handleCriticalError(event.reason);
            }
        });
    </script>

    <!-- Token Security (Services) -->
    <script src="src/lib/services/token-storage.js"></script>

    <!-- Storage Adapters: Now loaded dynamically via ES6 imports (see bootstrap.js and storage-manager-unified.js) -->
    <!-- OLD SYSTEM - REMOVED: These were causing "StorageAdapterBase is not defined" errors -->
    <!-- <script src="src/lib/adapters/storage-adapter-base.js"></script> -->
    <!-- <script src="src/lib/adapters/local-storage-adapter.js"></script> -->
    <!-- <script src="src/lib/adapters/local-git-adapter.js"></script> -->
    <!-- <script src="src/lib/adapters/github-storage-adapter.js"></script> -->
    <!-- <script src="src/lib/components/storage-manager-unified.js"></script> -->

    <!-- OAuth (Adapters) -->
    <script src="src/lib/adapters/github-oauth.js"></script>
    <!-- Migration PAT -> OAuth: DÃ©sactivÃ© car le wizard gÃ¨re maintenant les modes correctement -->
    <!-- <script src="src/lib/services/migrate-to-oauth.js"></script> -->

    <!-- Legacy GitHub adapter (rÃ©trocompatibilitÃ© - Services) -->
    <script src="src/lib/services/github-adapter.js"></script>

    <!-- LinearCalendar Component -->
    <script src="src/lib/components/base/configurable-component.js"></script>
    <script src="src/lib/components/linear-calendar/linear-calendar.js"></script>

    <!-- Core Components -->
    <script src="src/lib/components/config-wizard.js"></script>
    <script src="src/lib/services/markdown-renderer.js"></script>
    <script src="src/lib/services/markdown-parser.js"></script>
    <script src="src/lib/services/storage.js"></script>
    <script src="src/lib/components/editor.js"></script>

    <!-- Modern Config System (modules ES6) -->
    <!-- Note: Core modules (EventBus, ConfigManager, PluginSystem) are loaded dynamically by bootstrap.js -->
    <script type="module" src="src/core/router.js"></script>
    <script type="module" src="src/lib/components/json-schema-form-builder.js"></script>
    <script type="module" src="src/lib/components/settings-view.js"></script>
    <script type="module" src="src/lib/components/settings-integration.js"></script>

    <!-- Bootstrap - Initializes storageManager and core systems FIRST -->
    <script type="module" src="src/bootstrap.js"></script>

    <!-- Main App - Must wait for bootstrap to finish (loaded as deferred classic script) -->
    <script defer src="src/app-init.js"></script>
</body>

</html>
